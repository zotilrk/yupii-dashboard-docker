name: Deploy to Self-Hosted EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Stop existing containers
      run: |
        sudo docker-compose down || true
        sudo docker stop yupii-dashboard-app yupii-dashboard-global || true
        sudo docker rm yupii-dashboard-app yupii-dashboard-global || true
        
    - name: Build and start services
      run: |
        # Copy environment variables
        echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" > .env
        echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> .env
        echo "AWS_DEFAULT_REGION=us-west-1" >> .env
        echo "S3_BUCKET_NAME=xideralaws-curso-carlos" >> .env
        
        # Build and start with docker-compose
        docker-compose up -d --build
        
    - name: Verify deployment
      run: |
        sleep 10
        docker-compose ps
        curl -f http://localhost:8501 || echo "Main dashboard not ready yet"
        curl -f http://localhost:8502 || echo "Global dashboard not ready yet"
        
    - name: Show public URLs
      run: |
        PUBLIC_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)
        echo "ğŸ‰ Deployment completed!"
        echo "ğŸ“Š Main Dashboard: http://$PUBLIC_IP:8501"
        echo "ğŸŒ Global Dashboard: http://$PUBLIC_IP:8502"
